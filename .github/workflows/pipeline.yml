name: Pipeline

on:
  push:
    branches: [main, master]
    paths-ignore: ["**.md", ".gitignore"]
  pull_request:
    branches: [main, master]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  FLUTTER_VERSION: "stable"
  JAVA_VERSION: "17"

defaults:
  run:
    shell: bash

jobs:
  # -----------------------------------------------------------------
  # STAGE 1: QUALITY ASSURANCE
  # -----------------------------------------------------------------
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
      - uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_VERSION }}
          cache: true
      - uses: actions/setup-java@v5
        with:
          distribution: "temurin"
          java-version: ${{ env.JAVA_VERSION }}

      - run: flutter pub get

      - name: Format
        run: dart format .

      - name: Commit formatting changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "style: auto-format code [skip ci]"
          file_pattern: "*.dart"

      - name: Analyze
        run: flutter analyze --fatal-infos --fatal-warnings

      - name: Unit Tests
        run: flutter test --coverage

      - name: Upload codecov
        uses: codecov/codecov-action@v5
        with:
          files: coverage/lcov.info

      - name: Install pana
        run: |
          dart pub global activate pana
          echo "$HOME/.pub-cache/bin" >> $GITHUB_PATH

      - name: Pana Score
        run: pana --no-warning --exit-code-threshold 130

  android-check:
    name: Android Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_VERSION }}
      - uses: actions/setup-java@v5
        with:
          distribution: "temurin"
          java-version: ${{ env.JAVA_VERSION }}
      - run: flutter pub get

      - name: Build Example APK
        run: cd example && flutter build apk --debug

  ios-check:
    name: iOS Check
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v6
      - uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_VERSION }}
      - run: flutter pub get

      - name: Build Example iOS
        run: cd example && flutter build ios --no-codesign --debug

  # -----------------------------------------------------------------
  # STAGE 2: QUALITY GATE
  # -----------------------------------------------------------------
  quality-gate:
    name: Quality Gate
    needs: [code-quality, android-check, ios-check]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Final Review
        run: |
          if [ "${{ needs.code-quality.result }}" != "success" ]; then
            echo "::error::Code quality failed"
            exit 1
          fi
          if [ "${{ needs.android-check.result }}" != "success" ]; then
            echo "::error::Android check failed"
            exit 1
          fi
          if [ "${{ needs.ios-check.result }}" != "success" ]; then
            echo "::error::iOS check failed"
            exit 1
          fi
          echo "All quality checks passed!"

  # -----------------------------------------------------------------
  # STAGE 3: RELEASE (GitHub Tag & Release only)
  # -----------------------------------------------------------------
  release:
    name: Release
    needs: [quality-gate]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Check version and consistency
        id: check_version
        run: |
          VERSION=$(cat VERSION | tr -d '[:space:]')
          PUBSPEC_VERSION=$(grep 'version:' pubspec.yaml | sed 's/version: //' | tr -d '[:space:]')

          if [ "$PUBSPEC_VERSION" != "$VERSION" ]; then
            echo "::error::pubspec.yaml version ($PUBSPEC_VERSION) does not match VERSION file ($VERSION)"
            exit 1
          fi

          if git ls-remote --tags origin | grep -q "refs/tags/v$VERSION"; then
            echo "Tag v$VERSION already exists on remote. Skipping release."
            echo "do_release=false" >> $GITHUB_OUTPUT
          else
            echo "New version $VERSION detected. Proceeding with release."
            echo "do_release=true" >> $GITHUB_OUTPUT
            echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Create Git Tag
        if: steps.check_version.outputs.do_release == 'true'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag -a "v${{ steps.check_version.outputs.VERSION }}" -m "Release v${{ steps.check_version.outputs.VERSION }}"
          git push origin "v${{ steps.check_version.outputs.VERSION }}"

      - name: Create GitHub Release
        if: steps.check_version.outputs.do_release == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ steps.check_version.outputs.VERSION }}"
          generate_release_notes: true
          body: |
            Release v${{ steps.check_version.outputs.VERSION }}

            Note: pub.dev publishing must be performed manually.
            See CHANGELOG.md for details.
